<main>
    <div id="content">
        <h1>Available Venues & Events</h1>

        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Search listings...">
            <button id="searchBtn">Search</button>
        </div>

        <div id="listingsContainer" class="listings"></div>
    </div>
</main>

<style>
    main {
        padding: 20px;
        font-size: 20px;
    }

    .listing {
        padding: 15px;
        margin: 10px 0;
        border: 1px solid #ddd;
        border-radius: 6px;
        cursor: pointer;
        background-color: #f9f9f9;
        transition: background 0.2s;
    }

    .listing:hover {
        background-color: #eaeaea;
    }

    .search-bar {
        margin-bottom: 20px;
    }

    .search-bar input {
        font-size: 18px;
        padding: 8px;
        width: 250px;
    }
</style>

<script>
// Fetch and display listings when the page loads
window.onload = loadListings;

async function loadListings(query = "") {
    const container = document.getElementById("listingsContainer");
    container.innerHTML = "<p>Loading...</p>";

    const res = await fetch("/listings/data?search=" + encodeURIComponent(query));
    const listings = await res.json();

    container.innerHTML = "";

    listings.forEach(listing => {
        const div = document.createElement("div");
        div.className = "listing";
        div.onclick = () => selectListing(listing);

        div.innerHTML = `
            <strong>${listing.name}</strong><br>
            Location: ${listing.location}<br>
            Capacity: ${listing.capacity}<br>
            Timeslots: ${listing.timeslots.join(", ")}<br><br>
            <button class="selectBtn">Add to Profile</button>
        `;

        container.appendChild(div);
    });
}

// Search when the button is clicked
document.getElementById("searchBtn").onclick = () => {
    const query = document.getElementById("searchInput").value;
    loadListings(query);
};

// Clicking on a listing triggers this
async function selectListing(listing) {
    const confirmAdd = confirm(
        `Add "${listing.name}" to your profile?`
    );

    if (!confirmAdd) return;

    const res = await fetch("/listing/book", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ listingId: listing._id })
    });

    if (res.ok) {
        alert("Listing added to your profile!");
    } else {
        alert("Error: Could not add to profile.");
    }
}

</script>
